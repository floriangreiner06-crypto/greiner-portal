<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Greiner Organigramm</title>
    <script src="/static/lib/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8fafc;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 14px;
            color: #718096;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        #orgchart {
            flex: 1;
            overflow: hidden;
            background: white;
        }

        .node {
            cursor: pointer;
        }

        .node rect {
            fill: #fff;
            stroke: #4299e1;
            stroke-width: 2px;
            rx: 8px;
            transition: all 0.3s;
        }

        .node:hover rect {
            fill: #ebf8ff;
            stroke: #2b6cb0;
            stroke-width: 3px;
        }

        .node text {
            font-size: 14px;
            fill: #2d3748;
            pointer-events: none;
        }

        .node.has-children rect {
            stroke: #48bb78;
        }

        .node.collapsed rect {
            fill: #f7fafc;
        }

        .link {
            fill: none;
            stroke: #cbd5e0;
            stroke-width: 2px;
        }

        .node-name {
            font-weight: 600;
            font-size: 15px;
        }

        .node-title {
            font-size: 12px;
            fill: #718096;
        }

        .node-location {
            font-size: 11px;
            fill: #a0aec0;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #4299e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">üè¢ Auto Greiner Organigramm</div>
            <div class="subtitle">Organisationsstruktur & Hierarchie</div>
            <div class="controls">
                <button class="btn btn-primary" onclick="expandAll()">‚ûï Alle Aufklappen</button>
                <button class="btn btn-secondary" onclick="collapseAllNodes()">‚ûñ Alle Zuklappen</button>
                <button class="btn btn-secondary" onclick="resetViewport()">üîÑ Zur√ºcksetzen</button>
                <button class="btn btn-secondary" onclick="fitToScreen()">üìê Anpassen</button>
            </div>
        </div>
        <div id="orgchart">
            <div class="loading">Lade Organigramm...</div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let svg, g, root, tree, zoom;
        const width = window.innerWidth;
        const height = window.innerHeight - 100;
        const nodeWidth = 200;
        const nodeHeight = 80;
        const levelHeight = 150;

        // Initialisierung
        function init() {
            // SVG erstellen
            svg = d3.select("#orgchart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            // Zoom-Verhalten
            zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);

            // Container f√ºr den Tree
            g = svg.append("g")
                .attr("transform", `translate(${width / 2},50)`);

            // Tree-Layout
            tree = d3.tree()
                .nodeSize([nodeWidth + 50, levelHeight])
                .separation((a, b) => {
                    return a.parent === b.parent ? 1 : 1.2;
                });

            // Daten laden
            loadData();
        }

        // Daten laden
        async function loadData() {
            try {
                const response = await fetch('/api/mitarbeiter/organigramm-data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Hierarchie erstellen
                root = d3.hierarchy(data);
                root.x0 = 0;
                root.y0 = 0;

                // Initiales Kollabieren (nur Level 0 + 1 sichtbar)
                root.descendants().forEach(d => {
                    if (d.depth > 1) {
                        d._children = d.children;
                        d.children = null;
                    }
                });

                // Erste Darstellung
                update(root);

                // Loading entfernen
                d3.select(".loading").remove();

            } catch (error) {
                console.error("Fehler beim Laden:", error);
                d3.select(".loading")
                    .style("color", "#e53e3e")
                    .text("‚ùå Fehler beim Laden der Daten");
            }
        }

        // Tree aktualisieren
        function update(source) {
            if (!root) return;

            const duration = 400;
            const treeData = tree(root);
            const nodes = treeData.descendants();
            const links = treeData.links();

            // Nodes
            const node = g.selectAll(".node")
                .data(nodes, d => d.id || (d.id = ++i));

            // Enter
            const nodeEnter = node.enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.x0},${source.y0})`)
                .on("click", click);

            // Rechteck
            nodeEnter.append("rect")
                .attr("width", nodeWidth)
                .attr("height", nodeHeight)
                .attr("x", -nodeWidth / 2)
                .attr("y", -nodeHeight / 2);

            // Name
            nodeEnter.append("text")
                .attr("class", "node-name")
                .attr("dy", "-10")
                .attr("text-anchor", "middle")
                .text(d => d.data.name);

            // Position
            nodeEnter.append("text")
                .attr("class", "node-title")
                .attr("dy", "10")
                .attr("text-anchor", "middle")
                .text(d => d.data.position || "");

            // Standort
            nodeEnter.append("text")
                .attr("class", "node-location")
                .attr("dy", "25")
                .attr("text-anchor", "middle")
                .text(d => d.data.location || "");

            // Update
            const nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.transition()
                .duration(duration)
                .attr("transform", d => `translate(${d.x},${d.y})`);

            nodeUpdate.select("rect")
                .attr("class", d => {
                    if (d._children) return "has-children collapsed";
                    if (d.children) return "has-children";
                    return "";
                });

            // Exit
            const nodeExit = node.exit()
                .transition()
                .duration(duration)
                .attr("transform", d => `translate(${source.x},${source.y})`)
                .remove();

            // Links
            const link = g.selectAll(".link")
                .data(links, d => d.target.id);

            // Enter
            const linkEnter = link.enter()
                .insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal(o, o);
                });

            // Update
            linkEnter.merge(link)
                .transition()
                .duration(duration)
                .attr("d", d => diagonal(d.source, d.target));

            // Exit
            link.exit()
                .transition()
                .duration(duration)
                .attr("d", d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();

            // Speichere alte Position
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Click Handler
        function click(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else if (d._children) {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }

        // Diagonal-Pfad f√ºr Links
        function diagonal(s, d) {
            return `M ${s.x} ${s.y}
                    C ${s.x} ${(s.y + d.y) / 2},
                      ${d.x} ${(s.y + d.y) / 2},
                      ${d.x} ${d.y}`;
        }

        // Counter f√ºr IDs
        let i = 0;

        // Alle aufklappen
        function expandAll() {
            if (!root) return;
            root.descendants().forEach(d => {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            update(root);
        }

        // Alle zuklappen
        function collapseAllNodes() {
            if (!root) return;
            root.descendants().forEach(d => {
                if (d.depth > 0 && d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            update(root);
        }

        // Viewport zur√ºcksetzen
        function resetViewport() {
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(width / 2, 50));
        }

        // An Bildschirm anpassen
        function fitToScreen() {
            if (!root) return;
            
            const bounds = g.node().getBBox();
            const fullWidth = bounds.width;
            const fullHeight = bounds.height;
            const midX = bounds.x + fullWidth / 2;
            const midY = bounds.y + fullHeight / 2;

            const scale = 0.9 / Math.max(fullWidth / width, fullHeight / height);
            const translate = [width / 2 - scale * midX, height / 2 - scale * midY];

            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }

        // Resize Handler
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight - 100;
            
            svg.attr("width", newWidth).attr("height", newHeight);
            
            if (root) {
                fitToScreen();
            }
        });

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
