#!/usr/bin/env python3
"""MCP Server f√ºr Claude Desktop - Greiner Portal"""
import json
import sys
import subprocess
import sqlite3
from pathlib import Path

BASE_DIR = Path('/opt/greiner-portal')
DB_PATH = BASE_DIR / 'data/greiner_controlling.db'

def handle_request(request):
    method = request.get('method')
    params = request.get('params', {})
    
    try:
        if method == 'files/read':
            path = BASE_DIR / params.get('path', '')
            with open(path, 'r') as f:
                return {'content': f.read(), 'path': str(path)}
        
        elif method == 'files/list':
            path = BASE_DIR / params.get('path', '')
            items = [{'name': p.name, 'type': 'dir' if p.is_dir() else 'file'} 
                    for p in path.iterdir()]
            return {'items': items, 'path': str(path)}
        
        elif method == 'shell/exec':
            result = subprocess.run(
                params.get('command'),
                shell=True,
                cwd=str(BASE_DIR),
                capture_output=True,
                text=True,
                timeout=30
            )
            return {
                'stdout': result.stdout,
                'stderr': result.stderr,
                'returncode': result.returncode
            }
        
        elif method == 'db/query':
            conn = sqlite3.connect(DB_PATH)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute(params.get('query'))
            
            if params.get('query').strip().upper().startswith('SELECT'):
                rows = [dict(row) for row in cursor.fetchall()]
                return {'results': rows, 'count': len(rows)}
            else:
                conn.commit()
                return {'affected_rows': cursor.rowcount}
        
        elif method == 'system/info':
            return {
                'base_dir': str(BASE_DIR),
                'db_path': str(DB_PATH),
                'python_version': sys.version
            }
        
        else:
            return {'error': f'Unknown method: {method}'}
    
    except Exception as e:
        return {'error': str(e)}

def main():
    print("MCP Server started", file=sys.stderr)
    for line in sys.stdin:
        try:
            request = json.loads(line)
            response = handle_request(request)
            print(json.dumps(response), flush=True)
        except Exception as e:
            print(json.dumps({'error': str(e)}), flush=True)

if __name__ == '__main__':
    main()
